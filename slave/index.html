<html>
<head>
  <title>My Browser Does What?</title>
</head>

<body>
  <h1>My Browser Does What?</title>
  <h3>iJS - Munich - Oct 2019</h3>

  <div id="app">

  </div>
</body>

<template id="waiting">
Waiting...
</template>

<template id="websockets">
This is the Websockets demo<br/>
<input type="text" id="wsText">
<button id="wsSend" type="button">Send</button>
<div id="lastMessages"></div>
</template>

<template id="notifications">
This is the notifications demo
</template>

<template id="location">
Geolocation API demo<br/>
<button id="locationBtn">Where Am I?</button>
<div id="location"></div>
</template>

<template id="pagevisibility">
Page Visibility demo <br/>
Page is visible ðŸ˜‰<br/>
Look at the page title
</template>

<template id="speechsynthesis">
Speech API demo <br/>
<form>
  <input type="text" id="speechTxt" placeholder="Text to speak"/><br/>
  <select id="voices"></select><br/>
  Pitch: <input type="number" id="pitch" value="1" length=4 />Rate: <input type="number" id="rate" value="1" length=4 /><br/>
  <button id="speak">Speak</button>
</form>
</template>

<template id="online">
Online/Offline Status Demo<br/>
<div style="height: 300px; width: 300px; border-radius: 100%; background-color: green" id="statusBall">
  <div style="text-align:center; padding-top: 130px; color: white; font-weight: bold;" id="statusText">ONLINE</div>
</div>
</template>

<template id="deviceorientationevent">
Device Orientation Demo <br/>
<div id="room" style="width: 95%; height: 75%; border: solid 3px black; border-radius: 25px;"> 
  <div id="ball" style="position: relative; height: 50px; width: 50px; border-radius: 100%; background-color: blue;">&nbsp;</div>
</div>
</template>

<script type="text/javascript">
let demos = {};
let currentDemo;

const showTemplate = (name, doNotStart) => {
  if (demos[currentDemo] && demos[currentDemo].destroy) demos[currentDemo].destroy();
  let container = document.querySelector("#app");
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }

  let template = document.querySelector(`#${name}`);
  var clone = document.importNode(template.content, true);

  container.appendChild(clone);

  if (!doNotStart) demos[name].init();

  currentDemo = name;
}

const noDemo = () => {
  showTemplate("waiting", true);
}

noDemo();
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
  let socket = io();
  let socketConnected = false;

  socket.on("connect", () => {
    socketConnected = true;
  });
  socket.on("demoChange", msg => {
    if (msg.demo) {
      showTemplate(msg.demo);
    } else {
      noDemo();
    }
  });
</script>

<script type="text/javascript">
// WebSockets demo
demos.websockets = {
  init: () => {
    let lastMessages = [];

    socket.on("demo", data => {
      lastMessages.push(data.msg.replace("<", "&gt;").replace(">", "&lt;"));
      if (lastMessages.length > 5) {
        lastMessages.shift();
      }
      document.querySelector("#lastMessages").innerHTML = lastMessages.join("<br/>");
    });

    document.querySelector("#wsSend").addEventListener("click", () => {
      socket.emit("demo", {demo: "ws", msg: document.querySelector("#wsText").value});
    });
  }
};

demos.notifications = {
  init: () => {
    if (!Notification.permissions) {
      Notification.requestPermission(() => {
        let notification = new Notification("Thank you for accepting those notifications");
      });
    }

    socket.on("notification", msg => {
      let notification = new Notification(msg.text, msg.options);
    });
  }
};

demos.location = {
  init: () => {
    document.querySelector("#locationBtn").addEventListener("click", () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.querySelector("#location").innerText = `You are located at ${pos.coords.latitude}, ${pos.coords.longitude}`;
        });
      }
    });
  }
}

demos.pagevisibility = {
  init: () => {
    document.addEventListener("visibilitychange", () => {
      switch (document.visibilityState) {
        case "visible": 
          document.title = "My Browser Does What?";
          break;
        case "hidden":
          document.title = "(Page Hidden) - My Browser Does What?";
          break;
        case "prerender":
          document.title = "(Page Rendering) - My Browser Does What?"
          break;
      }
    });
  }
}

demos.speechsynthesis = {
  init: () => {
    const synth = window.speechSynthesis;
    const inputTxt = document.querySelector("#speechTxt");
    const voiceSelect = document.querySelector("#voices");
    const pitch = document.querySelector("#pitch");
    const rate = document.querySelector("#rate");

    let voices = [];

    const populateVoiceList = () => {
      voices = synth.getVoices();
      voices.map(v => {
        let option = document.createElement("option");
        option.textContent = `${v.name} (${v.lang})`;
        option.setAttribute("data-name", v.name);
        voiceSelect.appendChild(option);
      });
    }
    populateVoiceList();

    document.querySelector("#speak").addEventListener("click", () => {
      let utterThis = new SpeechSynthesisUtterance(inputTxt.value);
      let selectedVoice = voiceSelect.selectedOptions[0].getAttribute("data-name");
      utterThis.voice = synth.getVoices().find(v => v.name == selectedVoice);
      utterThis.pitch = pitch.value;
      utterThis.rate = rate.value;
      synth.speak(utterThis);
    });
  }
}

handleOnlineChange = () => {
  if (navigator.onLine) {
    document.querySelector("#statusBall").style.backgroundColor = "green";
    document.querySelector("#statusText").innerText = "ONLINE";
  } else {
    document.querySelector("#statusBall").style.backgroundColor = "red";
    document.querySelector("#statusText").innerText = "OFFLINE";
  }
}

demos.online = {
  init: () => {
    window.ononline = handleOnlineChange;
    window.onoffline = handleOnlineChange;
  },
  destroy: () => {
    window.ononline = null;
    window.onoffline = null;
  }
}

demos.deviceorientationevent = {
  interval: null,
  init: () => {
    const MAX_SPEED = 10; //px/cycle
    const FRAME_RATE = 30;
    const REDRAW_MS = Math.floor(1000/FRAME_RATE);
    const BALL_SIZE = 50;
    const ROOM_HEIGHT = document.querySelector("#room").clientHeight;
    const ROOM_WIDTH = document.querySelector("#room").clientWidth;
    let top = 0;
    let left = 0;
    let xSpeed = 0;
    let ySpeed = 0;

    const redraw = () => {
      top = top + xSpeed;
      left = left + ySpeed;
      if (top < 0) top = 0;
      if (top > ROOM_HEIGHT - BALL_SIZE) top = ROOM_HEIGHT - BALL_SIZE;
      if (left < 0) left = 0;
      if (left > ROOM_WIDTH - BALL_SIZE) left = ROOM_WIDTH - BALL_SIZE;
      document.querySelector("#ball").style.top = top;
      document.querySelector("#ball").style.left = left;
    }
    window.ondeviceorientation = (event) => {
      let x = event.beta;
      let y = event.gamma;
      if (x > 90) x = 90;
      if (x < -90) x = -90;
      if (y > 90) y = 90;
      if (y < -90) y = -90;
      xSpeed = MAX_SPEED * x/90;
      ySpeed = MAX_SPEED * y/90;
    }

    demos.deviceorientationevent.interval = setInterval(redraw, REDRAW_MS);
  },
  destroy: () => {
    clearInterval(demos.deviceorientationevent.interval);
    window.ondeviceorientation = null;
  }
}
</script>

<script type="text/javascript">

showTemplate("deviceorientationevent");
</script>

</html>