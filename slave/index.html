<html>
<head>
  <title>My Browser Does What?</title>
</head>

<body>
  <h1>My Browser Does What?</title>
  <h3>iJS - Munich - Oct 2019</h3>

  <div id="app">

  </div>
</body>

<template id="waiting">
Waiting...
</template>

<template id="websockets">
This is the Websockets demo<br/>
<input type="text" id="wsText">
<button id="wsSend" type="button">Send</button>
<div id="lastMessages"></div>
</template>

<template id="notifications">
This is the notifications demo
</template>

<template id="location">
Geolocation API demo<br/>
<div id="location"></div>
<div id="moved"></div>
<div id="timer"></div>
</template>

<script type="text/javascript">
let demos = {};

const showTemplate = (name, doNotStart) => {
  let container = document.querySelector("#app");
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }

  let template = document.querySelector(`#${name}`);
  var clone = document.importNode(template.content, true);

  container.appendChild(clone);

  if (!doNotStart) demos[name].init();
}

const noDemo = () => {
  showTemplate("waiting", true);
}

noDemo();
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
  let socket = io();
  socket.on("connect", () => {
    console.log("Connected");
  });
  socket.on("demoChange", msg => {
    if (msg.demo) {
      showTemplate(msg.demo);
    } else {
      noDemo();
    }
  });
</script>

<script type="text/javascript">
// WebSockets demo
demos.websockets = {
  init: () => {
    let lastMessages = [];

    socket.on("demo", data => {
      lastMessages.push(data.msg.replace("<", "&gt;").replace(">", "&lt;"));
      if (lastMessages.length > 5) {
        lastMessages.shift();
      }
      document.querySelector("#lastMessages").innerHTML = lastMessages.join("<br/>");
    });

    document.querySelector("#wsSend").addEventListener("click", () => {
      socket.emit("demo", {demo: "ws", msg: document.querySelector("#wsText").value});
    });
  }
}

</script>

<script type="text/javascript">
demos.notifications = {
  init: () => {
    if (!Notification.permissions) {
      Notification.requestPermission(() => {
        let notification = new Notification("Thank you for accepting those notifications");
      });
    }

    socket.on("notification", msg => {
      let notification = new Notification(msg.text, msg.options);
    });
  }
}
</script>

<script type="text/javascript">
demos.location = {
  init: () => {
    var original;
    let timer = 10 * 60 * 1000;

    const decreaseTimer = () => {
      timer--;
      document.querySelector("#timer").innerText = `Tracking for ${Math.floor(timer/60/1000)}:${timer%60}`;
      setTimeout(decreaseTimer, 1000);
    }
    
    if ("geolocation" in navigator) {
      let watchID = navigator.geolocation.watchPosition(pos => {
        document.querySelector("#location").innerText = `You are located at ${pos.coords.latitude}, ${pos.coords.longitude}`;

        if (!original || pos.coords.latitude !== original.latitude || pos.coords.longitude !== original.longitude) {
          if (original) document.querySelector("#moved").innerText = "Looks like you moved";
          original = pos.coords;
        }
      }, err => console.log(err), {enableHighAccuracy: true});

      setTimeout(() => navigator.geolocation.clearWatch(watchID), timer);
      setTimeout(decreaseTimer, 1000);
    }
  }
}

</script>

<script type="text/javascript">

showTemplate("location");
</script>

</html>