<html>
<head>
  <title>My Browser Does What?</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

</head>

<style>

@keyframes blink-animation {
  to {
    visibility: hidden;
  }
}
@-webkit-keyframes blink-animation {
  to {
    visibility: hidden;
  }
}

h1, h2, h3, h4, h5, .center {
  text-align: center;
}

</style>

<body class="fluid">
  <div class="row">
    <div class="col-12">
      <h1>My Browser Does What?</h1>
      <h3>iJS - Munich - Oct 2019</h3>
    </div>
  </div>
  <div class="row">
    <div class="col-12 center">
      <div id="app"></div>
    </div>
  </div>
</body>

<template id="waiting">
<div class="row">
  <div class="col-12">
    Waiting...
  </div>
</div>
</template>

<template id="websockets">
  <div class="row">
    <div class="col-12">
      <h4>Websockets Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
        <input type="text" id="wsText">
        <button id="wsSend" type="button">Send</button>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div id="lastMessages"></div>
    </div>
  </div>
</template>

<template id="notifications">
  <div class="row">
    <div class="col-12">
      <h4>Notifications Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <button id="notificationsBtn">Listen for notifications</button>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div id="notificationsStatus"></div>
    </div>
  </div>
</template>

<template id="location">
  <div class="row">
    <div class="col-12">
      <h4>Geolocation Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <button id="locationBtn">Where Am I?</button>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div id="location"></div>
    </div>
  </div>
</template>

<template id="pagevisibility">
  <div class="row">
    <div class="col-12">
      <h4>Page Visibility Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      Page is <span id="pagevisibilityStatus">visible ðŸ˜‰</span>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      Look at the page title
    </div>
  </div>
</template>

<template id="speechsynthesis">
  <div class="row">
    <div class="col-12">
      <h4>Speech Synthesis Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <form>
          <input type="text" id="speechTxt" placeholder="Text to speak"/><br/>
          <select id="voices"></select><br/>
          Pitch: <input type="number" id="pitch" value="1" length=4 />Rate: <input type="number" id="rate" value="1" length=4 /><br/>
          <button id="speak" type="button">Speak</button>
        </form>
    </div>
  </div>
</template>

<template id="online">
  <div class="row">
    <div class="col-12">
      <h4>Online/Offline Status Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12 center">
      <div style="text-align: center; height: 300px; width: 300px; border-radius: 100%; background-color: green" id="statusBall">
        <div style="text-align:center; padding-top: 130px; color: white; font-weight: bold;" id="statusText">ONLINE</div>
      </div>
    </div>
  </div>
</template>

<template id="deviceorientationevent">
  <div class="row">
    <div class="col-12">
      <h4>Device Orientation Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12 center">
      <div id="room" style="text-align: center; width: 95%; height: 300px; border: solid 3px black; border-radius: 25px;"> 
        <div id="ball" style="position: relative; height: 50px; width: 50px; border-radius: 100%; background-color: blue;">&nbsp;</div>
      </div>
    </div>
  </div>
</template>

<template id="vibrate">
  <div class="row">
    <div class="col-12">
      <h4>Vibration API Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div id="vibrateName"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <button id="vibrateBtn">Start</button>
      <button id="vibrateStopBtn">Stop</button>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <img id="vibrateImg" height="50%"/>
    </div>
  </div>
</template>

<template id="clipboard">
  <div class="row">
    <div class="col-12">
      <h4>Copy & Paste (Clipboard API) Demo</h4>
    </div>
  </div>
  <div class="row">
    <div class="col-12">     
      <button id="copyBtn">Copy</button>
      <button id="pasteBtn">Paste</button>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <input type="text" id="clipboardText" value="Some text to copy"/>
    </div>
  </div>
</template>

<template id="getusermedia">
getUserMedia demo<br/>
<video id="getUserMediaVideo" style="display: none;"></video>
<canvas id="getUserMediaCanvas"></canvas>
<div>
  Filters: 
  <button id="getUserMediaNoFilter">None</button>
  <button id="getUserMediaBW">B&W</button>
  <button id="getUserMediaInvert">Invert</button>
  <button id="getUserMediaRandom">Randomize</button>
</div>
</template>

<template id="audio">
Web Audio Demo<br/>
Turn on the volume and move your mouse or tap around the screen<br/>
Frequency: <span id="audioFreq"></span>, Gain: <span id="audioGain"></span>
</template>

<template id="gamepad">
Gamepad API<br/>
<div id="gamepadPleaseWait" style="display: none">Please wait a second</div>
<div id="gamepadPlay">
  <button class="gamepadBtn" id="up">UP</button>
  <button class="gamepadBtn" id="down">DOWN</button>
  <button class="gamepadBtn" id="left">LEFT</button>
  <button class="gamepadBtn" id="right">RIGHT</button>
  <button class="gamepadBtn" id="a">A</button>
  <button class="gamepadBtn" id="b">B</button>
</div>
</template>

<template id="bluetooth">
Bluetooth API<br/>
<div>
  <span id="heart">ðŸ’“</span>
  <span id="heartRate"></span>
</div>
</template>

<script type="text/javascript">
let demos = {};
let currentDemo;

const showTemplate = (name, doNotStart) => {
  if (demos[currentDemo] && demos[currentDemo].destroy) demos[currentDemo].destroy();
  let container = document.querySelector("#app");
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }

  let template = document.querySelector(`#${name}`);
  var clone = document.importNode(template.content, true);

  container.appendChild(clone);

  if (!doNotStart) demos[name].init();

  currentDemo = name;
}

const noDemo = () => {
  showTemplate("waiting", true);
}

noDemo();
</script>

<script src="/socket.io/socket.io.js"></script>
<script>
  let socket = io();
  let socketConnected = false;

  socket.on("connect", () => {
    socketConnected = true;
  });
  socket.on("demoChange", msg => {
    if (msg.demo) {
      showTemplate(msg.demo);
    } else {
      noDemo();
    }
  });
</script>

<script type="text/javascript">
// WebSockets demo
demos.websockets = {
  init: () => {
    let lastMessages = [];

    socket.on("demo", data => {
      lastMessages.push(data.msg.replace("<", "&gt;").replace(">", "&lt;"));
      if (lastMessages.length > 5) {
        lastMessages.shift();
      }
      document.querySelector("#lastMessages").innerHTML = lastMessages.join("<br/>");
    });

    document.querySelector("#wsSend").addEventListener("click", () => {
      socket.emit("demo", {demo: "ws", msg: document.querySelector("#wsText").value});
    });
  }
};

demos.notifications = {
  init: () => {
    document.querySelector("#notificationsBtn").addEventListener("click", () => {
      Notification.requestPermission(() => {
        if (navigator.serviceWorker) {
          navigator.serviceWorker.register("slave/sw").then(registration => {
            registration.showNotification("You will now receive notifications");
            socket.on("notification", msg => {
              registration.showNotification(msg.text, msg.options);
            });
          }, err => console.log("Cannot register notifications sw", err));
        } else {
          let notification = new Notification("Thank you for accepting those notifications");
        }
      });
    });
    document.querySelector("#notificationsStatus").innerText = `Waiting on user, current permission: ${Notification.permission}`;
  }
};

demos.location = {
  init: () => {
    document.querySelector("#locationBtn").addEventListener("click", () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          const mapUrl = `https://www.google.com/maps/@${pos.coords.latitude},${pos.coords.longitude},17z`;
          document.querySelector("#location").innerText = `You are located at ${pos.coords.latitude}, ${pos.coords.longitude}  `;
          let link = document.createElement("a");
          link.setAttribute("href", mapUrl);
          link.innerText = "(View on Google Maps)";
          let paragraph = document.createElement("p");
          paragraph.appendChild(link);
          document.querySelector("#location").appendChild(paragraph);
        });
      }
    });
  }
}

demos.pagevisibility = {
  init: () => {
    document.addEventListener("visibilitychange", () => {
      switch (document.visibilityState) {
        case "visible": 
          document.title = "My Browser Does What?";
          document.querySelector("#pagevisibilityStatus").innerText = "visible ðŸ˜‰";
          break;
        case "hidden":
          document.title = "(Page Hidden) - My Browser Does What?";
          document.querySelector("#pagevisibilityStatus").innerText = "not visible";
          break;
        case "prerender":
          document.title = "(Page Rendering) - My Browser Does What?";
          document.querySelector("#pagevisibilityStatus").innerText = "RENDERING";
          break;
      }
    });
  }
}

demos.speechsynthesis = {
  init: () => {
    const synth = window.speechSynthesis;
    const inputTxt = document.querySelector("#speechTxt");
    const voiceSelect = document.querySelector("#voices");
    const pitch = document.querySelector("#pitch");
    const rate = document.querySelector("#rate");

    let voices = [];

    const populateVoiceList = () => {
      voices = synth.getVoices();
      voices.map(v => {
        let option = document.createElement("option");
        option.textContent = `${v.name} (${v.lang})`;
        option.setAttribute("data-name", v.name);
        voiceSelect.appendChild(option);
      });
    }
    populateVoiceList();
    speechSynthesis.onvoiceschanged = populateVoiceList;

    document.querySelector("#speak").addEventListener("click", () => {
      let utterThis = new SpeechSynthesisUtterance(inputTxt.value);
      let selectedVoice = voiceSelect.selectedOptions[0].getAttribute("data-name");
      utterThis.voice = synth.getVoices().find(v => v.name == selectedVoice);
      utterThis.pitch = pitch.value;
      utterThis.rate = rate.value;
      synth.speak(utterThis);
    });
  }
}

handleOnlineChange = () => {
  if (navigator.onLine) {
    document.querySelector("#statusBall").style.backgroundColor = "green";
    document.querySelector("#statusText").innerText = "ONLINE";
  } else {
    document.querySelector("#statusBall").style.backgroundColor = "red";
    document.querySelector("#statusText").innerText = "OFFLINE";
  }
}

demos.online = {
  init: () => {
    window.ononline = handleOnlineChange;
    window.onoffline = handleOnlineChange;
  },
  destroy: () => {
    window.ononline = null;
    window.onoffline = null;
  }
}

demos.deviceorientationevent = {
  interval: null,
  init: () => {
    const MAX_SPEED = 20; //px/cycle
    const FRAME_RATE = 30;
    const REDRAW_MS = Math.floor(1000/FRAME_RATE);
    const BALL_SIZE = 50;
    const ROOM_HEIGHT = document.querySelector("#room").clientHeight;
    const ROOM_WIDTH = document.querySelector("#room").clientWidth;
    let top = 0;
    let left = 0;
    let xSpeed = 0;
    let ySpeed = 0;

    const redraw = () => {
      top = top + xSpeed;
      left = left + ySpeed;
      if (top < 0) top = 0;
      if (top > ROOM_HEIGHT - BALL_SIZE) top = ROOM_HEIGHT - BALL_SIZE;
      if (left < 0) left = 0;
      if (left > ROOM_WIDTH - BALL_SIZE) left = ROOM_WIDTH - BALL_SIZE;
      document.querySelector("#ball").style.top = top;
      document.querySelector("#ball").style.left = left;
    }
    window.ondeviceorientation = (event) => {
      let x = event.beta;
      let y = event.gamma;
      if (x > 90) x = 90;
      if (x < -90) x = -90;
      if (y > 90) y = 90;
      if (y < -90) y = -90;
      xSpeed = MAX_SPEED * x/90;
      ySpeed = MAX_SPEED * y/90;
    }

    demos.deviceorientationevent.interval = setInterval(redraw, REDRAW_MS);
  },
  destroy: () => {
    clearInterval(demos.deviceorientationevent.interval);
    window.ondeviceorientation = null;
  }
}

const vibrations = [
  {
    name: "Imperial March",
    img: "/darthvader.png",
    pattern: [500,110,500,110,450,110,200,110,170,40,450,110,200,110,170,40,500]
  },
  {
    name: "Super Mario Theme",
    img: "/mario.png",
    pattern: [125,75,125,275,200,275,125,75,125,275,200,600,200,600]
  },
  {
    name: "James Bond 007",
    img: "/bond.png",
    pattern: [200,100,200,275,425,100,200,100,200,275,425,100,75,25,75,125,75,25,75,125,100,100]
  },
  {
    name: "SOS Morse Code",
    img: "/sos.png",
    pattern: [100,30,100,30,100,200,200,30,200,30,200,200,100,30,100,30,100]
  }
];

demos.vibrate = {
  init: () => {
    document.querySelector("#vibrateImg").style.visibility = "none";
    document.querySelector("#vibrateStopBtn").addEventListener("click", () => {
      if ("vibrate" in navigator) {
        document.querySelector("#vibrateName").innerText = "";
        document.querySelector("#vibrateImg").style.visibility = "none";
        navigator.vibrate(0);
      }
    });
    document.querySelector("#vibrateBtn").addEventListener("click", () => {
      if ("vibrate" in navigator) {
        let vibration = vibrations[Math.round(Math.random()*3)];
        let img = document.querySelector("#vibrateImg");
        img.setAttribute("src", vibration.img);
        img.style.visibility = "visible";
        document.querySelector("#vibrateName").innerText = vibration.name;
        setTimeout(navigator.vibrate(vibration.pattern), 0);
      } else {
        document.querySelector("#vibrateName").innerText = "Vibration API not available on this device";
      }
    });
  }
}

demos.clipboard = {
  init: () => {
    let textBox = document.querySelector("#clipboardText");
    document.querySelector("#copyBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(textBox.value).then(_ => {
      }).catch(e => {
        console.log("Error", e);
      });
    });
    document.querySelector("#pasteBtn").addEventListener("click", () => {
      navigator.clipboard.readText().then(data => {
        textBox.value = data;
      }).catch(e => {
        console.log("Error", e);
      });
    });
  }
}

demos.getusermedia = {
  init: () => {
    let constraints = { video: true };
    let canvas = document.querySelector("#getUserMediaCanvas");
    let backCanvas = document.createElement("canvas");
    let video = document.querySelector("#getUserMediaVideo");
    let context = canvas.getContext("2d");
    let backContext = backCanvas.getContext("2d");

    let currentFilter = "none";
    document.querySelector("#getUserMediaNoFilter").addEventListener("click", () => currentFilter = "none");
    document.querySelector("#getUserMediaBW").addEventListener("click", () => currentFilter = "blackwhite");
    document.querySelector("#getUserMediaInvert").addEventListener("click", () => currentFilter = "invert");
    document.querySelector("#getUserMediaRandom").addEventListener("click", () => currentFilter = "randomize");

    let pixelManipulation = {
      none: (r, g, b, a) => {
        return {r, g, b, a}
      },
      blackwhite: ((r, g, b, a) => {
        let brightness = (3*r+4*g+b)>>>3;
        return {
          r: brightness,
          g: brightness,
          b: brightness,
          a
        };
      }),
      invert: ((r, g, b, a) => {
        return {
          r: g,
          g: r,
          b,
          a
        };
      }),
      randomize: ((r, g, b, a) => {
        return {
          r: [r, g, b][Math.round(Math.random()*2)],
          g: [r, g, b][Math.round(Math.random()*2)],
          b: [r, g, b][Math.round(Math.random()*2)],
          a
        }
      })
    }

    navigator.mediaDevices.getUserMedia(constraints)
      .then(mediaStream => {
        video.srcObject = mediaStream;
        video.onloadedmetadata = () => {
          video.play();

          let WIDTH = video.videoWidth;
          let HEIGHT = video.videoHeight;
          canvas.height = HEIGHT;
          backCanvas.height = HEIGHT;
          canvas.width = WIDTH;
          backCanvas.width = WIDTH;

          let loop = () => {
            if (!video.paused && !video.ended) {
              backContext.drawImage(video, 0, 0); 
              let imageData = backContext.getImageData(0, 0, WIDTH, HEIGHT);
              let data = imageData.data;
              for (let i = 0; i < data.length; i+= 4) {
                let result = pixelManipulation[currentFilter](data[i], data[i+1], data[i+2], data[i+3]);
                data[i] = result.r;
                data[i+1] = result.g;
                data[i+2] = result.b;
                data[i+3] = result.a;
              }
              imageData.data = data;
              context.putImageData(imageData, 0, 0);
              setTimeout(loop, 1000/30);
            }
          }
          loop();
        };  
      })
      .catch(e => console.log(e));
  }
}

let oscillator;
demos.audio = {
  init: (ctx) => {
    let audioStarted = false;
    const start = () => {
      if (audioStarted) return;
      audioStarted = true;
      let audioCtx = new AudioContext();
      oscillator = audioCtx.createOscillator();
      let gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      let maxFreq = 6000;
      let maxVol = 0.04;
      let initialFreq = 3000;
      let initialVol = 0.001;
      oscillator.detune.value = 100;
      oscillator.start(0);
      gainNode.gain.value = initialVol;
      gainNode.gain.minValue = initialVol;
      gainNode.gain.maxValue = initialVol;

      const updateAudio = (e) => {
        e.preventDefault();
        let freq, gain;
        if (e.touches) {
          freq = (e.touches[0].pageX/window.innerWidth) * maxFreq;
          gain = (e.touches[0].pageY/window.innerHeight) * maxVol;
        } else {
          freq = (e.pageX/window.innerWidth) * maxFreq;
          gain = (e.pageY/window.innerHeight) * maxVol;
        }
        oscillator.frequency.value = freq;
        gainNode.gain.value = gain;
        document.querySelector("#audioFreq").innerText = Math.floor(freq);
        document.querySelector("#audioGain").innerText = gain;
      }

      document.onmousemove = updateAudio;
      document.ontouchmove = updateAudio;
    }
    document.onclick = start;
    document.ontouch = start;
  },
  destroy: () => {
    oscillator.stop();
  }
}

demos.gamepad = {
  init: () => {
    let delay = 1000;
    const pleaseWait = () => {
      document.querySelector("#gamepadPleaseWait").style.display = "inherit";
      document.querySelector("#gamepadPlay").style.display = "none";
    }
    const play = () => {
      document.querySelector("#gamepadPleaseWait").style.display = "none";
      document.querySelector("#gamepadPlay").style.display = "inherit";
    }
    let buttons = document.querySelectorAll(".gamepadBtn");
    for (let i = 0; i < buttons.length; i++) {
      buttons[i].addEventListener("click", (e) => {
        pleaseWait();
        socket.emit("demo", {name: "gamepad", button: e.target.id});
        setTimeout(play, delay);
      });
    }
  }
}

demos.bluetooth = {
  init: () => {
    socket.on("demo", msg => {
      if (msg.name !== "bluetooth") return;
      document.querySelector("#heartRate").innerText = msg.heartRate;
      let blinkAnimation = `blink-animation 1s steps(5, start) infinite`;
      document.querySelector("#heart").style.animation = blinkAnimation;
    });
  }
}
</script>

<script type="text/javascript">

showTemplate("waiting", true);
let params = {};
const urlParams = new URLSearchParams(window.location.search);
const template = urlParams.get('template');
if (template) showTemplate(template);
</script>

</html>